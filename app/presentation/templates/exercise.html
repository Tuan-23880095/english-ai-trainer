{% extends "base.html" %}
{% block title %}Exercise{% endblock %}
{% block content %}
<div class="exercise-main-container">
    <h2>English Speaking Assistant</h2>
    <div class="chatbox" id="chatbox"></div>

    <div class="input-area">
        <button class="voice-btn" id="btn-voice">üé§ N√≥i ti·∫øng Anh</button>
        <button class="tts-btn" id="btn-tts">üîä Nghe l·∫°i</button>
        <br/><br/>
        <textarea id="inputText" placeholder="B·∫°n h√£y n√≥i ho·∫∑c nh·∫≠p n·ªôi dung..."></textarea>
        <br/>
        <button id="btn-send">Send</button>
    </div>
</div>
{% endblock %}
{% block script %}
<link rel="stylesheet" href="/static/css/exercise.css">
<script>
    // Web Speech API (ch·ªâ Chrome/Edge h·ªó tr·ª£ t·ªët)
    let recognition;
    function startListening() {
        if (!('webkitSpeechRecognition' in window)) {
            alert('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ speech-to-text!');
            return;
        }
        recognition = new webkitSpeechRecognition();
        recognition.lang = 'en-US';
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;
        recognition.onresult = function(event) {
            const transcript = event.results[0][0].transcript;
            document.getElementById('inputText').value = transcript;
            addMessage('B·∫°n (speech)', transcript);
        };
        recognition.onerror = function(event) {
            alert('L·ªói nh·∫≠n di·ªán gi·ªçng n√≥i: ' + event.error);
        }
        recognition.start();
    }

    function addMessage(who, text) {
        const chatbox = document.getElementById('chatbox');
        chatbox.innerHTML += `<b>${who}:</b> ${text}<br>`;
        chatbox.scrollTop = chatbox.scrollHeight;
    }

    function speakText() {
        const text = document.getElementById('inputText').value;
        if (text) speak(text);
    }
    function speak(text) {
        if ('speechSynthesis' in window) {
            const utter = new SpeechSynthesisUtterance(text);
            utter.lang = 'en-US';
            window.speechSynthesis.speak(utter);
        } else {
            alert('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ text-to-speech!');
        }
    }

    // Thay ƒë·ªïi: ·ªü ƒë√¢y b·∫°n n√™n t√≠ch h·ª£p g·ªçi API backend th·∫≠t
    async function sendMessage() {
        const text = document.getElementById('inputText').value.trim();
        if (!text) return;
        addMessage('B·∫°n', text);

        // --- G·ª≠i l√™n backend exercise (v√≠ d·ª• call API /exercise/conversation) ---
        // ƒê·ªÉ demo, v·∫´n ƒë·ªÉ fakeAIResponse. Khi c√≥ API th·∫≠t, thay h√†m n√†y.
        fakeAIResponse(text);
        document.getElementById('inputText').value = '';
    }

    function fakeAIResponse(text) {
        let response = '';
        if (text.toLowerCase().includes('hello')) response = "Hi! How are you today?";
        else if (text.toLowerCase().includes('name')) response = "My name is EnglishBot. Nice to meet you!";
        else if (text.toLowerCase().includes('weather')) response = "It's sunny and beautiful today!";
        else response = "That's interesting! Could you tell me more?";
        setTimeout(() => {
            addMessage('AI', response);
            speak(response);
        }, 600);
    }

    document.getElementById('btn-voice').onclick = startListening;
    document.getElementById('btn-tts').onclick = speakText;
    document.getElementById('btn-send').onclick = sendMessage;
</script>
{% endblock %}
